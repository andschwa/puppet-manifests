---
classes:
  - ghost
  - gitlab
  - mumble
  - nginx
  - postgresql
  - postgresql::globals
  - postgresql::server
  - prosody
  - redis
  - vsftpd

ghost::blogs:
  andrew:
    production_url: https://schwartzmeyer.com
  jackie:
    production_url: https://jackie.schwartzmeyer.com
    production_port: 2369

gitlab::git_email: git@suchcodemuchlove.com
gitlab::gitlab_branch: v6.7.2
gitlab::gitlabshell_branch: v1.9.1
gitlab::gitlab_manage_nginx: false
gitlab::gitlab_backup: "%{gitlab::git_home}/backups"
gitlab::gitlab_dbtype: pgsql
gitlab::gitlab_dbname: git
gitlab::gitlab_dbuser: git
gitlab::gitlab_dbpwd: "%{hiera('gitlab_dbpwd')}"
gitlab::gitlab_domain: suchcodemuchlove.com
gitlab::gitlab_ssl: true
gitlab::gitlab_ssl_cert: '/etc/ssl/certs/suchcodemuchlove.com.crt'
gitlab::gitlab_ssl_key: '/etc/ssl/private/suchcodemuchlove.com.key'

mumble::snapshot: true

nginx::nginx_upstreams:
  schwartzmeyer:
    members:
      - localhost:2368
  jackie:
    members:
      - localhost:2369
  gitlab:
    members:
      - unix:/home/git/gitlab/tmp/sockets/gitlab.socket

nginx::nginx_vhosts:
  idahothegoodlife.com:
    www_root: '/var/www/idahothegoodlife.com'
    rewrite_www_to_non_www: true
  schwartzmeyer.com:
    proxy: http://schwartzmeyer
    proxy_set_header:
      - Host $http_host
      - X-Forwarded-Proto $scheme
      - X-Forwarded-For $proxy_add_x_forwarded_for
      - X-Real-IP $remote_addr
    ssl: true
    ssl_cert: '/etc/ssl/certs/schwartzmeyer.com.crt'
    ssl_key: '/etc/ssl/private/schwartzmeyer.com.key'
    rewrite_www_to_non_www: true
    rewrite_to_https: true
  jackie.schwartzmeyer.com:
    proxy: http://jackie
    proxy_set_header:
      - Host $http_host
      - X-Forwarded-Proto $scheme
      - X-Forwarded-For $proxy_add_x_forwarded_for
      - X-Real-IP $remote_addr
    ssl: true
    ssl_cert: '/etc/ssl/certs/schwartzmeyer.com.crt'
    ssl_key: '/etc/ssl/private/schwartzmeyer.com.key'
  suchcodemuchlove.com:
    www_root: '/home/git/gitlab/public'
    client_max_body_size: '20m'
    try_files:
      - '$uri'
      - '$uri/index.html'
      - '$uri.html'
      - '@gitlab'
    vhost_cfg_append:
      server_tokens: 'off'
      error_page: '502 /502.html'
    ssl: true
    ssl_cert: '/etc/ssl/certs/suchcodemuchlove.com.crt'
    ssl_key: '/etc/ssl/private/suchcodemuchlove.com.key'
    rewrite_www_to_non_www: true
    rewrite_to_https: true

nginx::nginx_locations:
  schwartzmeyer_files:
    vhost: schwartzmeyer.com
    location: '/files/'
    location_alias: '/var/www/files/'
    location_cfg_append:
      autoindex: 'on'
      autoindex_exact_size: 'off'
      autoindex_localtime: 'on'
    ssl: true
  suchcodemuchlove_proxy:
    vhost: suchcodemuchlove.com
    location: '@gitlab'
    proxy: http://gitlab
    proxy_read_timeout: '300'
    location_cfg_append:
      proxy_connect_timeout: '300'
      proxy_redirect: 'off'
      proxy_set_header:
        - Host $http_host
        - X-Forwarded-Proto $scheme
        - X-Forwarded-For $proxy_add_x_forwarded_for
        - X-Real-IP $remote_addr
    ssl: true
  suchcodemuchlove_assets:
    vhost: suchcodemuchlove.com
    location: '~ ^/(assets)/'
    www_root: '/home/git/gitlab/public'
    location_cfg_append:
      gzip_static: 'on'
      expires: max
      add_header: Cache-Control public
    ssl: true

postgresql::globals::manage_package_repo: true
postgresql::globals::version: '9.3'
postgresql::dbs:
  git:
    user: git
    password: "%{hiera('gitlab_dbpwd')}"

person::groups:
  - git

prosody::admins:
    - andrew@schwartzmeyer.com
    - andrew@suchcodemuchlove.com
prosody::ssl_protocol: sslv23
prosody::ssl_options:
  - no_sslv2
  - no_ticket
  - no_compression
  - cipher_server_preference
  - single_dh_use
  - single_ecdh_use
prosody::ssl_ciphers: 'HIGH+kEDH:HIGH+kEECDH:HIGH:!PSK:!SRP:!3DES:!aNULL'
prosody::ssl_curve: secp384r1
prosody::modules:
  - offline
prosody::virtualhosts:
  schwartzmeyer.com:
    ssl_cert: '/etc/ssl/certs/schwartzmeyer.com.crt'
    ssl_key: '/etc/ssl/private/schwartzmeyer.com.key'
  suchcodemuchlove.com:
    ssl_cert: '/etc/ssl/certs/suchcodemuchlove.com.crt'
    ssl_key: '/etc/ssl/private/suchcodemuchlove.com.key'

ubuntu::location: http://mirrors.digitalocean.com/ubuntu/
ubuntu::sources:
  prosody:
    location: http://packages.prosody.im/debian
    repos: main
    key: 74D9DBB5

ufw::allows:
  allow-ftp-data-from-all:
    port: 20
  allow-ftp-listen-from-all:
    port: 21
  allow-ftp-passive-from-all:
    port: 42000:42256
  allow-http-from-all:
    port: 80
  allow-https-from-all:
    port: 443
  allow-mumble-from-all:
    port: 64738
  allow-mumble-udp-from-all:
    proto: udp
    port: 64738
  allow-prosody-from-all:
    port: 5222

vsftpd::template: vsftpd/empty.conf.erb
vsftpd::directives:
  allow_anon_ssl: 'YES'
  connect_from_port_20: 'YES'
  dual_log_enable: 'YES'
  force_dot_files: 'YES'
  guest_enable: 'YES'
  hide_ids: 'YES'
  listen: 'YES'
  local_enable: 'YES'
  no_anon_password: 'YES'
  ssl_enable: 'YES'
  use_localtime: 'YES'
  write_enable: 'NO'
  virtual_use_local_privs: 'YES'
  anon_root: '/var/www/public'
  max_clients: 10
  pasv_min_port: 42000
  pasv_max_port: 42256
  ftpd_banner: Welcome to this awesome server, friend!
  local_root: '/home/virtual/$USER'
  nopriv_user: ftp
  rsa_cert_file: '/etc/ssl/certs/schwartzmeyer.com.crt'
  rsa_private_key_file: '/etc/ssl/private/schwartzmeyer.com.key'
  user_config_dir: '/etc/vsftpd/user_conf'
  user_sub_token: '$USER'
